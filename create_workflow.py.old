import os
import sys
import json
import base64
import requests
from groq import Groq

# --- CONFIGURACI√ìN ---
REPO_OWNER = "SaturCerezo"
REPO_NAME = "git-to-x-automation"
# ---------------------

def generate_yaml_with_groq(client, topic):
    """
    Se conecta a la API de Groq para generar un archivo de workflow.
    """
    print(f"ü§ñ Contactando a Groq (IA) para crear un workflow sobre: '{topic}'...")

    prompt = f"""
    Basado en el tema '{topic}', crea un archivo de workflow completo para GitHub Actions.
    El archivo debe llamarse 'generated-workflow.yml'.
    El workflow debe ser simple y funcional. Por ejemplo, si el tema es 'correr tests de python',
    el workflow deber√≠a hacer checkout del c√≥digo, instalar python, instalar dependencias y correr pytest.
    El resultado debe ser √∫nicamente el c√≥digo YAML, sin explicaciones adicionales, 
    empezando con la l√≠nea 'name: ...' y sin usar triple comillas (```).
    """

    try:
        chat_completion = client.chat.completions.create(
            messages=[
                {"role": "user", "content": prompt}
            ],
            model="llama-3.1-8b-instant", # Modelo verificado
        )

        content = chat_completion.choices[0].message.content
        print("‚úÖ Groq ha generado el c√≥digo YAML con √©xito.")
        return content

    except Exception as e:
        print(f"‚ùå Error al contactar con Groq API: {e}")
        return None

def commit_file_to_github(pat, file_path, content, commit_message):
    """
    Usa la API de GitHub para guardar el archivo en el repositorio.
    (Esta funci√≥n es la misma que ten√≠as en el script de Gemini)
    """
    print(f"üñêÔ∏è  Preparando para guardar el archivo en GitHub en la ruta: {file_path}...")

    url = f"https://api.github.com/repos/SaturCerezo/git-to-x-automation/contents/{file_path}"

    headers = {
        "Authorization": f"token {pat}",
        "Accept": "application/vnd.github.v3+json"
    }

    get_response = requests.get(url, headers=headers)
    sha = None
    if get_response.status_code == 200:
        sha = get_response.json()["sha"]
        print("   - El archivo ya existe, se actualizar√°.")

    encoded_content = base64.b64encode(content.encode('utf-8')).decode('utf-8')

    data = {
        "message": commit_message,
        "content": encoded_content,
        "sha": sha
    }

    put_response = requests.put(url, headers=headers, data=json.dumps(data))

    if put_response.status_code == 201:
        print("‚úÖ ¬°Archivo creado en GitHub con √©xito!")
    elif put_response.status_code == 200:
        print("‚úÖ ¬°Archivo actualizado en GitHub con √©xito!")
    else:
        print(f"‚ùå Error al subir el archivo a GitHub: {put_response.status_code}")
        print(put_response.json())


def main():
    print("[INFO] Proyecto Synapse-M√≥vil v1.0 (Groq) iniciado.")

    # 1. Inicializar cliente de IA (Groq)
    try:
        groq_client = Groq() # Lee GROQ_API_KEY autom√°ticamente
        print("[INFO] Cliente de Groq inicializado.")
    except Exception as e:
        print(f"[ERROR] No se pudo inicializar el cliente de Groq: {e}")
        sys.exit(1)

    # 2. Obtener el Token de GitHub
    github_pat = os.environ.get("GITHUB_PAT")
    if not github_pat:
        print("[ERROR] La variable de entorno GITHUB_PAT no est√° configurada.")
        print("Por favor, config√∫rala antes de ejecutar el script.")
        sys.exit(1)
    print("[INFO] Token de GitHub (GITHUB_PAT) cargado.")

    # 3. Pedimos al usuario el tema para el workflow
    workflow_topic = input("üìù ¬øSobre qu√© tema quieres que la IA cree el workflow? (ej: correr tests de python): ")

    # 4. Generar el YAML con Groq
    yaml_content = generate_yaml_with_groq(groq_client, workflow_topic)

    # 5. Si se gener√≥ bien, subirlo a GitHub
    if yaml_content:
        # Asegur√©monos de que el YAML empieza correctamente
        if not yaml_content.strip().startswith("name:"):
            print("[ADVERTENCIA] El YAML generado por la IA no empieza con 'name:'. Revisi√≥n manual recomendada.")

        file_name = "generated-workflow.yml"
        full_path = f".github/workflows/{file_name}"
        commit_msg = f"feat: Add workflow for '{workflow_topic}' generated by AI"

        commit_file_to_github(github_pat, full_path, yaml_content, commit_msg)

# Punto de entrada del script
if __name__ == "__main__":
    main()

